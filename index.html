<script>
    // ПЕРЕМЕННЫЕ: Храним клиент базы и текущий режим (Вход или Регистрация)
    let _supabase = null;
    let isLoginMode = true;

    // ИНИЦИАЛИЗАЦИЯ: Функция, которая подключает твой сайт к Supabase
    function getSupabase() {
        if (!_supabase) {
            if (window.supabase) {
                _supabase = window.supabase.createClient(
                    'https://fceltmajcgvmjtmqmbuh.supabase.co', 
                    'sb_publishable_9arN0yQwPf1N8zSh30VjFA_SSUR3P5Q'
                );
            }
        }
        return _supabase;
    }

    // МОДАЛКА: Открыть или закрыть окно
    window.toggleModal = function() {
        const modal = document.getElementById('modalReg');
        if (modal) modal.classList.toggle('active');
    };

    // НАВИГАЦИЯ: Переключение между блоками (Вход / Сброс пароля / Новый пароль)
    window.showView = function(viewName) {
        const blocks = { auth: 'authBlock', reset: 'resetBlock', newPass: 'newPassBlock' };
        Object.values(blocks).forEach(id => document.getElementById(id).style.display = 'none');
        document.getElementById(blocks[viewName]).style.display = 'block';
    };

    // ПЕРЕКЛЮЧАТЕЛЬ: Меняет режим формы с "Войти" на "Создать аккаунт"
    window.toggleAuthMode = function() {
        isLoginMode = !isLoginMode;
        document.getElementById('authTitle').innerText = isLoginMode ? 'Вход' : 'Создать аккаунт';
        document.getElementById('submitBtn').innerText = isLoginMode ? 'Войти' : 'Зарегистрироваться';
        document.getElementById('switchBtn').innerText = isLoginMode ? 'Нет аккаунта? Создать' : 'Уже есть аккаунт? Войти';
    };

    // ЛОГИКА АВТОРИЗАЦИИ: Самая главная функция (отправляет данные в базу)
    window.handleAuth = async function(e) {
        e.preventDefault();
        const client = getSupabase();
        if (!client) return alert("База еще загружается... Подождите 2 сек.");

        const btn = document.getElementById('submitBtn');
        const email = document.getElementById('login').value;
        const pass = document.getElementById('pass').value;
        
        btn.innerText = "Загрузка...";
        btn.disabled = true;

        // Выбираем действие: либо вход, либо регистрация
        const { error } = isLoginMode 
            ? await client.auth.signInWithPassword({ email, password: pass })
            : await client.auth.signUp({ email, password: pass });

        if (error) {
            alert("Ошибка: " + error.message);
        } else {
            window.toggleModal();
            // Анимация прыжка шапки при успехе
            const hat = document.getElementById('mainHat');
            if (hat) {
                hat.classList.add('success-jump');
                setTimeout(() => hat.classList.remove('success-jump'), 1000);
            }
            alert(isLoginMode ? "Вы вошли!" : "Аккаунт создан!");
        }
        btn.innerText = isLoginMode ? "Войти" : "Зарегистрироваться";
        btn.disabled = false;
    };

    // СБРОС ПАРОЛЯ: Отправляет письмо на почту
    window.handleResetPassword = async function(e) {
        e.preventDefault();
        const client = getSupabase();
        const email = document.getElementById('resetEmail').value;
        const { error } = await client.auth.resetPasswordForEmail(email, { redirectTo: window.location.href });
        if (error) alert(error.message);
        else { alert("Ссылка отправлена!"); window.showView('auth'); }
    };

    // ОБНОВЛЕНИЕ ПАРОЛЯ: Сохраняет новый пароль, когда юзер пришел из письма
    window.handleUpdatePassword = async function(e) {
        e.preventDefault();
        const client = getSupabase();
        const pass = document.getElementById('newPass').value;
        const { error } = await client.auth.updateUser({ password: pass });
        if (error) alert(error.message);
        else { alert("Пароль обновлен!"); window.toggleModal(); window.showView('auth'); }
    };

    // СОБЫТИЯ ЗАГРУЗКИ: Проверяем токены и настраиваем закрытие окна
    window.addEventListener('load', () => {
        getSupabase(); 
        if (window.location.hash.includes('type=recovery')) {
            window.toggleModal();
            window.showView('newPass');
        }
        const m = document.getElementById('modalReg');
        if (m) m.addEventListener('click', (e) => { if (e.target === m) window.toggleModal(); });
    });
</script>
